{% comment %}
  Section: Mousewheel Collection
  - Tạo landing page cho bộ sưu tập mới với hiệu ứng mousewheel control
  - Hỗ trợ hiển thị cả video và hình ảnh
  - Thiết kế tương tự như trang web YSL
{% endcomment %}

<!-- Mousewheel Collection CSS -->
{{ 'mousewheel-collection.css' | asset_url | stylesheet_tag }}

<div class="mousewheel-collection section-{{ section.id }} header-overlap-section needs-alt-logo" 
     id="mousewheel-collection-{{ section.id }}"
     data-height="{{ section.settings.height }}">
  <div class="mousewheel-swiper-container swiper">
    <div class="swiper-wrapper">
      {% for block in section.blocks %}
        <div class="swiper-slide" {{ block.shopify_attributes }}>
          {% case block.type %}
            {% when 'image' %}
              <div class="slide-content image-slide">
                {% assign desktop_image = block.settings.image %}
                {% assign mobile_image = block.settings.image_mobile | default: block.settings.image %}
                
                {% if desktop_image != blank or mobile_image != blank %}
                  <div class="image-wrapper">
                    <!-- Desktop Image -->
                    {% if desktop_image != blank %}
                      <img 
                        src="{{ desktop_image | img_url: 'master' }}"
                        alt="{{ desktop_image.alt | escape }}"
                        loading="lazy"
                        class="full-width-image desktop-media"
                      >
                    {% endif %}
                    
                    <!-- Mobile Image -->
                    {% if mobile_image != blank and mobile_image != desktop_image %}
                      <img 
                        src="{{ mobile_image | img_url: 'master' }}"
                        alt="{{ mobile_image.alt | escape }}"
                        loading="lazy"
                        class="full-width-image mobile-media"
                      >
                    {% endif %}
                    
                    {% if block.settings.heading != blank or block.settings.text != blank %}
                      <div class="slide-text-overlay">
                        {% if block.settings.heading != blank %}
                          <h2 class="slide-heading">{{ block.settings.heading }}</h2>
                        {% endif %}
                        {% if block.settings.text != blank %}
                          <div class="slide-text">{{ block.settings.text }}</div>
                        {% endif %}
                        {% if block.settings.button_label != blank and block.settings.button_link != blank %}
                          <a href="{{ block.settings.button_link }}" class="slide-button">
                            {{ block.settings.button_label }}
                          </a>
                        {% endif %}
                      </div>
                    {% endif %}
                  </div>
                {% else %}
                  <div class="placeholder-container">
                    {{ 'image' | placeholder_svg_tag: 'placeholder-svg' }}
                  </div>
                {% endif %}
              </div>
            {% when 'video' %}
              <div class="slide-content video-slide">
                {% assign desktop_video = block.settings.video %}
                {% assign mobile_video = block.settings.video_mobile | default: block.settings.video %}
                {% assign desktop_video_url = block.settings.video_url %}
                {% assign mobile_video_url = block.settings.video_url_mobile | default: block.settings.video_url %}
                
                <!-- Desktop Video -->
                <div class="desktop-media">
                  {% if desktop_video != blank %}
                    <!-- Shopify uploaded video - Desktop -->
                    <div class="video-wrapper">
                      <video 
                        playsinline 
                        loop 
                        muted 
                        autoplay
                        class="full-width-video"
                        id="shopify-video-desktop-{{ block.id }}"
                      >
                        {% for source in desktop_video.sources %}
                          <source src="{{ source.url }}" type="{{ source.mime_type }}">
                        {% endfor %}
                      </video>
                    </div>
                  {% elsif desktop_video_url != blank %}
                    <!-- External video URL - Desktop -->
                    <div class="video-wrapper">
                      {% if desktop_video_url.type == 'youtube' %}
                        <iframe 
                          src="https://www.youtube.com/embed/{{ desktop_video_url.id }}?autoplay=1&controls=0&mute=1&loop=1&playlist={{ desktop_video_url.id }}&rel=0&enablejsapi=1" 
                          frameborder="0" 
                          allow="autoplay; encrypted-media" 
                          allowfullscreen 
                          class="full-width-video"
                          id="youtube-desktop-{{ block.id }}"
                        ></iframe>
                      {% elsif desktop_video_url.type == 'vimeo' %}
                        <iframe 
                          src="https://player.vimeo.com/video/{{ desktop_video_url.id }}?background=1&autoplay=1&loop=1&byline=0&title=0" 
                          frameborder="0" 
                          webkitallowfullscreen 
                          mozallowfullscreen 
                          allowfullscreen 
                          class="full-width-video"
                          id="vimeo-desktop-{{ block.id }}"
                        ></iframe>
                      {% endif %}
                    </div>
                  {% else %}
                    <div class="placeholder-container">
                      {{ 'video' | placeholder_svg_tag: 'placeholder-svg' }}
                    </div>
                  {% endif %}
                </div>
                
                <!-- Mobile Video -->
                <div class="mobile-media">
                  {% if mobile_video != blank and mobile_video != desktop_video %}
                    <!-- Shopify uploaded video - Mobile -->
                    <div class="video-wrapper">
                      <video 
                        playsinline 
                        loop 
                        muted 
                        autoplay
                        class="full-width-video"
                        id="shopify-video-mobile-{{ block.id }}"
                      >
                        {% for source in mobile_video.sources %}
                          <source src="{{ source.url }}" type="{{ source.mime_type }}">
                        {% endfor %}
                      </video>
                    </div>
                  {% elsif mobile_video_url != blank and mobile_video_url != desktop_video_url %}
                    <!-- External video URL - Mobile -->
                    <div class="video-wrapper">
                      {% if mobile_video_url.type == 'youtube' %}
                        <iframe 
                          src="https://www.youtube.com/embed/{{ mobile_video_url.id }}?autoplay=1&controls=0&mute=1&loop=1&playlist={{ mobile_video_url.id }}&rel=0&enablejsapi=1" 
                          frameborder="0" 
                          allow="autoplay; encrypted-media" 
                          allowfullscreen 
                          class="full-width-video"
                          id="youtube-mobile-{{ block.id }}"
                        ></iframe>
                      {% elsif mobile_video_url.type == 'vimeo' %}
                        <iframe 
                          src="https://player.vimeo.com/video/{{ mobile_video_url.id }}?background=1&autoplay=1&loop=1&byline=0&title=0" 
                          frameborder="0" 
                          webkitallowfullscreen 
                          mozallowfullscreen 
                          allowfullscreen 
                          class="full-width-video"
                          id="vimeo-mobile-{{ block.id }}"
                        ></iframe>
                      {% endif %}
                    </div>
                  {% endif %}
                </div>
                
                {% if block.settings.heading != blank or block.settings.text != blank %}
                  <div class="slide-text-overlay">
                    {% if block.settings.heading != blank %}
                      <h2 class="slide-heading">{{ block.settings.heading }}</h2>
                    {% endif %}
                    {% if block.settings.text != blank %}
                      <div class="slide-text">{{ block.settings.text }}</div>
                    {% endif %}
                    {% if block.settings.button_label != blank and block.settings.button_link != blank %}
                      <a href="{{ block.settings.button_link }}" class="slide-button">
                        {{ block.settings.button_label }}
                      </a>
                    {% endif %}
                  </div>
                {% endif %}
              </div>
            {% when 'shop-the-look' %}
              <div class="slide-content shop-the-look-slide">
                <div class="shop-the-look-content" data-banner-width="{{ block.settings.banner_width }}">
                  <!-- Banner Section -->
                  <div class="shop-the-look-banner">
                    {% if block.settings.banner_image != blank %}
                      {%- assign banner_sizes = '(max-width: 768px) 100vw, ' | append: block.settings.banner_width | append: 'vw' -%}
                      {{ block.settings.banner_image | image_url: width: 1000 | image_tag:
                        class: 'shop-the-look-banner-image',
                        loading: 'lazy',
                        sizes: banner_sizes
                      }}
                    {% endif %}
                    
                    <div class="shop-the-look-banner-content">
                      {% if block.settings.banner_heading != blank %}
                        <h3 class="shop-the-look-banner-heading">{{ block.settings.banner_heading }}</h3>
                      {% endif %}
                      
                      {% if block.settings.banner_text != blank %}
                        <p class="shop-the-look-banner-text">{{ block.settings.banner_text }}</p>
                      {% endif %}
                      
                      {% if block.settings.button_label != blank and block.settings.button_link != blank %}
                        <a href="{{ block.settings.button_link }}" class="shop-the-look-banner-button">
                          {{ block.settings.button_label }}
                        </a>
                      {% endif %}
                    </div>
                  </div>

                  <!-- Image Slider Section -->
                  <div class="shop-the-look-images">
                    <div class="swiper-container shop-the-look-swiper-container" data-block-id="{{ block.id }}">
                      <div class="swiper-wrapper">
                        {% for i in (1..6) %}
                          {% assign image_setting = 'image_' | append: i %}
                          {% assign link_setting = 'link_' | append: i %}
                          {% assign title_setting = 'title_' | append: i %}
                          
                          {% if block.settings[image_setting] != blank %}
                            <div class="swiper-slide">
                              <div class="shop-the-look-image-item">
                                {% if block.settings[link_setting] != blank %}
                                  <a href="{{ block.settings[link_setting] }}" class="shop-the-look-image-link">
                                {% endif %}
                                
                                {{ block.settings[image_setting] | image_url: width: 400 | image_tag:
                                  class: 'shop-the-look-slide-image',
                                  loading: 'lazy',
                                  alt: block.settings[title_setting]
                                }}
                                
                                {% if block.settings[title_setting] != blank %}
                                  <div class="shop-the-look-image-overlay">
                                    <h4 class="shop-the-look-image-title">{{ block.settings[title_setting] }}</h4>
                                  </div>
                                {% endif %}
                                
                                {% if block.settings[link_setting] != blank %}
                                  </a>
                                {% endif %}
                              </div>
                            </div>
                          {% endif %}
                        {% endfor %}
                        
                        <!-- Placeholder slides if no images are set -->
                        {% assign has_images = false %}
                        {% for i in (1..6) %}
                          {% assign image_setting = 'image_' | append: i %}
                          {% if block.settings[image_setting] != blank %}
                            {% assign has_images = true %}
                            {% break %}
                          {% endif %}
                        {% endfor %}
                        
                        {% unless has_images %}
                          {% for i in (1..3) %}
                            <div class="swiper-slide">
                              <div class="shop-the-look-image-item placeholder-image">
                                {{ 'image' | placeholder_svg_tag: 'placeholder-svg' }}
                                <div class="shop-the-look-image-overlay">
                                  <h4 class="shop-the-look-image-title">Hình ảnh {{ i }}</h4>
                                </div>
                              </div>
                            </div>
                          {% endfor %}
                        {% endunless %}
                      </div>
                      
                      <!-- Navigation buttons inside swiper container -->
                      <div class="swiper-button-prev shop-the-look-prev" data-block-id="{{ block.id }}">
                        {% render 'svg-larrow' %}
                      </div>
                      <div class="swiper-button-next shop-the-look-next" data-block-id="{{ block.id }}">
                        {% render 'svg-rarrow' %}
                      </div>
                    </div>
                  </div>
                </div>
              </div>
          {% endcase %}
        </div>
      {% endfor %}
    </div>
    
    <!-- Pagination -->
    {% if section.settings.show_pagination %}
      <div class="swiper-pagination"></div>
    {% endif %}
    
    <!-- Navigation -->
    {% if section.settings.show_navigation %}
      <div class="swiper-button-next"></div>
      <div class="swiper-button-prev"></div>
    {% endif %}
  </div>
</div>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    // Wait for Swiper to be loaded
    if (typeof Swiper === 'undefined') {
      console.error('Swiper library not loaded');
      return;
    }
    
    const swiperContainer = document.querySelector('#mousewheel-collection-{{ section.id }} .mousewheel-swiper-container');
    
    if (swiperContainer) {
      const swiper = new Swiper(swiperContainer, {
        direction: 'vertical',
        slidesPerView: 1,
        spaceBetween: 0,
        speed: 1000,
        effect: 'slide',
        grabCursor: true,
        mousewheel: true,
        mousewheelControl: true,
        mousewheelReleaseOnEdges: true,
        mousewheelForceToAxis: true,
        mousewheelSensitivity: 1,
        keyboardControl: true,
        {% if section.settings.show_pagination %}
        pagination: '.swiper-pagination',
        paginationClickable: true,
        paginationDynamicBullets: true,
        {% endif %}
        {% if section.settings.show_navigation %}
        nextButton: '.swiper-button-next',
        prevButton: '.swiper-button-prev',
        {% endif %}
        onInit: function(swiper) {
          playCurrentSlideVideo(swiper);
        },
        onSlideChangeEnd: function(swiper) {
          playCurrentSlideVideo(swiper);
        },
        onResize: function(swiper) {
          swiper.update();
        }
      });
      
      function playCurrentSlideVideo(swiper) {
        try {
          // Pause all videos first (including Shopify uploaded videos)
          const allVideos = document.querySelectorAll('#mousewheel-collection-{{ section.id }} video');
          allVideos.forEach(video => {
            video.pause();
          });
          
          // Pause all YouTube videos
          const allYoutubeIframes = document.querySelectorAll('#mousewheel-collection-{{ section.id }} iframe[id^="youtube-"]');
          allYoutubeIframes.forEach(iframe => {
            if (iframe.contentWindow) {
              iframe.contentWindow.postMessage('{"event":"command","func":"pauseVideo","args":""}', '*');
            }
          });
          
          // Pause all Vimeo videos
          const allVimeoIframes = document.querySelectorAll('#mousewheel-collection-{{ section.id }} iframe[id^="vimeo-"]');
          allVimeoIframes.forEach(iframe => {
            if (iframe.contentWindow) {
              iframe.contentWindow.postMessage('{"method":"pause"}', '*');
            }
          });
          
          // Get current slide
          const currentSlide = swiper.slides[swiper.activeIndex];
          if (!currentSlide) return;
          
          // Play video if current slide has one (HTML5 video including Shopify uploaded)
          const video = currentSlide.querySelector('video');
          if (video) {
            video.currentTime = 0; // Reset to beginning
            video.play().catch(e => console.log('Video autoplay prevented:', e));
          }
          
          // Handle YouTube videos
          const youtubeIframe = currentSlide.querySelector('iframe[id^="youtube-"]');
          if (youtubeIframe && youtubeIframe.contentWindow) {
            youtubeIframe.contentWindow.postMessage('{"event":"command","func":"playVideo","args":""}', '*');
          }
          
          // Handle Vimeo videos
          const vimeoIframe = currentSlide.querySelector('iframe[id^="vimeo-"]');
          if (vimeoIframe && vimeoIframe.contentWindow) {
            vimeoIframe.contentWindow.postMessage('{"method":"play"}', '*');
          }
        } catch (error) {
          console.error('Error in playCurrentSlideVideo:', error);
        }
      }
      
      // Handle window resize
      window.addEventListener('resize', function() {
        swiper.update();
      });
    }
    
    // Initialize Shop the Look Swipers
    const shopLookSwipers = document.querySelectorAll('#mousewheel-collection-{{ section.id }} .shop-the-look-swiper-container');
    shopLookSwipers.forEach(function(swiperContainer) {
      const blockId = swiperContainer.getAttribute('data-block-id');
      const nextButton = document.querySelector('.shop-the-look-next[data-block-id="' + blockId + '"]');
      const prevButton = document.querySelector('.shop-the-look-prev[data-block-id="' + blockId + '"]');
      
      // Check if slides exist
      const slides = swiperContainer.querySelectorAll('.swiper-slide');
      if (slides.length === 0) {
        console.log('No slides found for shop-the-look swiper');
        return;
      }
      
      try {
        const shopLookSwiper = new Swiper(swiperContainer, {
          slidesPerView: 1,
          spaceBetween: 20,
          loop: false,
          navigation: {
            nextEl: nextButton,
            prevEl: prevButton,
          },
          breakpoints: {
            768: {
              slidesPerView: Math.min(2, slides.length),
              spaceBetween: 15,
            },
            1024: {
              slidesPerView: Math.min(3, slides.length),
              spaceBetween: 20,
            }
          },
          on: {
            init: function() {
              console.log('Shop-the-look swiper initialized for block:', blockId);
            }
          }
        });
      } catch (error) {
        console.error('Error initializing shop-the-look swiper:', error);
      }
    });
  });
</script>

{% schema %}
{
  "name": "Mousewheel Collection",
  "tag": "section",
  "class": "section",
  "settings": [
    {
      "type": "header",
      "content": "Cài đặt chung"
    },
    {
      "type": "select",
      "id": "height",
      "label": "Chiều cao section",
      "options": [
        {
          "value": "adapt",
          "label": "Tự động điều chỉnh theo nội dung"
        },
        {
          "value": "small",
          "label": "Nhỏ"
        },
        {
          "value": "medium",
          "label": "Vừa"
        },
        {
          "value": "large",
          "label": "Lớn"
        },
        {
          "value": "full",
          "label": "Toàn màn hình"
        }
      ],
      "default": "full"
    },
    {
      "type": "checkbox",
      "id": "show_pagination",
      "label": "Hiển thị chấm phân trang",
      "default": true
    },
    {
      "type": "checkbox",
      "id": "show_navigation",
      "label": "Hiển thị nút điều hướng",
      "default": true
    }
  ],
  "blocks": [
    {
      "type": "image",
      "name": "Hình ảnh",
      "settings": [
        {
          "type": "header",
          "content": "Hình ảnh Desktop"
        },
        {
          "type": "image_picker",
          "id": "image",
          "label": "Hình ảnh Desktop"
        },
        {
          "type": "header",
          "content": "Hình ảnh Mobile"
        },
        {
          "type": "image_picker",
          "id": "image_mobile",
          "label": "Hình ảnh Mobile",
          "info": "Nếu không chọn, sẽ sử dụng hình ảnh desktop"
        },
        {
          "type": "header",
          "content": "Nội dung"
        },
        {
          "type": "text",
          "id": "heading",
          "label": "Tiêu đề",
          "default": "Bộ sưu tập mới"
        },
        {
          "type": "richtext",
          "id": "text",
          "label": "Nội dung",
          "default": "<p>Mô tả ngắn về bộ sưu tập của bạn</p>"
        },
        {
          "type": "text",
          "id": "button_label",
          "label": "Nhãn nút",
          "default": "Xem thêm"
        },
        {
          "type": "url",
          "id": "button_link",
          "label": "Liên kết nút"
        }
      ]
    },
    {
      "type": "video",
      "name": "Video",
      "settings": [
        {
          "type": "header",
          "content": "Video Desktop"
        },
        {
          "type": "video",
          "id": "video",
          "label": "Video Desktop",
          "info": "Tải lên video hoặc chọn từ thư viện"
        },
        {
          "type": "video_url",
          "id": "video_url",
          "accept": ["youtube", "vimeo"],
          "label": "Video URL Desktop (tùy chọn)",
          "info": "YouTube hoặc Vimeo - sử dụng nếu không upload video"
        },
        {
          "type": "header",
          "content": "Video Mobile"
        },
        {
          "type": "video",
          "id": "video_mobile",
          "label": "Video Mobile",
          "info": "Video riêng cho mobile - nếu không chọn sẽ dùng video desktop"
        },
        {
          "type": "video_url",
          "id": "video_url_mobile",
          "accept": ["youtube", "vimeo"],
          "label": "Video URL Mobile (tùy chọn)",
          "info": "YouTube hoặc Vimeo cho mobile"
        },
        {
          "type": "header",
          "content": "Ảnh bìa"
        },
        {
          "type": "image_picker",
          "id": "video_cover",
          "label": "Ảnh bìa video Desktop (tùy chọn)",
          "info": "Sẽ sử dụng thumbnail mặc định nếu không chọn"
        },
        {
          "type": "image_picker",
          "id": "video_cover_mobile",
          "label": "Ảnh bìa video Mobile (tùy chọn)",
          "info": "Ảnh bìa riêng cho mobile"
        },
        {
          "type": "header",
          "content": "Nội dung"
        },
        {
          "type": "text",
          "id": "heading",
          "label": "Tiêu đề",
          "default": "Bộ sưu tập mới"
        },
        {
          "type": "richtext",
          "id": "text",
          "label": "Nội dung",
          "default": "<p>Mô tả ngắn về bộ sưu tập của bạn</p>"
        },
        {
          "type": "text",
          "id": "button_label",
          "label": "Nhãn nút",
          "default": "Xem thêm"
        },
        {
          "type": "url",
          "id": "button_link",
          "label": "Liên kết nút"
        }
      ]
    },
    {
      "type": "shop-the-look",
      "name": "Shop the Look",
      "settings": [
        {
          "type": "header",
          "content": "Banner Settings"
        },
        {
          "type": "image_picker",
          "id": "banner_image",
          "label": "Banner image"
        },
        {
          "type": "text",
          "id": "banner_heading",
          "label": "Banner heading",
          "default": "Shop the Look"
        },
        {
          "type": "text",
          "id": "banner_text",
          "label": "Banner text",
          "default": "Discover our latest collection"
        },
        {
          "type": "text",
          "id": "button_label",
          "label": "Button label",
          "default": "Shop Now"
        },
        {
          "type": "url",
          "id": "button_link",
          "label": "Button link"
        },
        {
          "type": "range",
          "id": "banner_width",
          "min": 30,
          "max": 60,
          "step": 5,
          "unit": "%",
          "label": "Banner width",
          "default": 40
        },
        {
          "type": "header",
          "content": "Image Slider Settings"
        },
        {
          "type": "image_picker",
          "id": "image_1",
          "label": "Image 1"
        },
        {
          "type": "text",
          "id": "title_1",
          "label": "Title 1"
        },
        {
          "type": "url",
          "id": "link_1",
          "label": "Link 1"
        },
        {
          "type": "image_picker",
          "id": "image_2",
          "label": "Image 2"
        },
        {
          "type": "text",
          "id": "title_2",
          "label": "Title 2"
        },
        {
          "type": "url",
          "id": "link_2",
          "label": "Link 2"
        },
        {
          "type": "image_picker",
          "id": "image_3",
          "label": "Image 3"
        },
        {
          "type": "text",
          "id": "title_3",
          "label": "Title 3"
        },
        {
          "type": "url",
          "id": "link_3",
          "label": "Link 3"
        },
        {
          "type": "image_picker",
          "id": "image_4",
          "label": "Image 4"
        },
        {
          "type": "text",
          "id": "title_4",
          "label": "Title 4"
        },
        {
          "type": "url",
          "id": "link_4",
          "label": "Link 4"
        },
        {
          "type": "image_picker",
          "id": "image_5",
          "label": "Image 5"
        },
        {
          "type": "text",
          "id": "title_5",
          "label": "Title 5"
        },
        {
          "type": "url",
          "id": "link_5",
          "label": "Link 5"
        },
        {
          "type": "image_picker",
          "id": "image_6",
          "label": "Image 6"
        },
        {
          "type": "text",
          "id": "title_6",
          "label": "Title 6"
        },
        {
          "type": "url",
          "id": "link_6",
          "label": "Link 6"
        }
      ]
    }
  ],
  "presets": [
    {
      "name": "Mousewheel Collection",
      "blocks": [
        {
          "type": "image"
        },
        {
          "type": "video"
        },
        {
          "type": "image"
        }
      ]
    }
  ]
}
{% endschema %}